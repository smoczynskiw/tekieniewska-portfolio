version: 2.1
jobs:
  test-sitespeed:
    machine: true
    steps:
      - run:
          name: Run test - cable
          command: |
            docker run --shm-size=1g --rm -v "$(pwd):/sitespeed.io" sitespeedio/sitespeed.io:latest -n 1 \
            https://stage.animedigitalnetwork.fr \
            --basicAuth ${BASIC_AUTH} \
            --slack.hookUrl ${SLACK_HOOK_URL} \
            --browsertime.connectivity.engine tsproxy -c cable
      - run:
          name: Run test - fast 3g
          command: |
            docker run --shm-size=1g --rm -v "$(pwd):/sitespeed.io" sitespeedio/sitespeed.io:latest -n 1 \
            https://stage.animedigitalnetwork.fr \
            --basicAuth ${BASIC_AUTH} \
            --slack.hookUrl ${SLACK_HOOK_URL} \
            --browsertime.connectivity.engine tsproxy -c 3gfast
      - run:
          name: Run test - slow 3g
          command: |
            docker run --shm-size=1g --rm -v "$(pwd):/sitespeed.io" sitespeedio/sitespeed.io:latest -n 1 \
            https://stage.animedigitalnetwork.fr \
            --basicAuth ${BASIC_AUTH} \
            --slack.hookUrl ${SLACK_HOOK_URL} \
            --browsertime.connectivity.engine tsproxy -c 3gslow
      - run:
          name: Compress results
          command: tar -cf ~/project/results.tar ~/project/sitespeed-result
      - store_artifacts:
          path: ~/project/results.tar

workflows:
  build:
    jobs:
      - test-sitespeed:
          filters:
            branches:
              only: master
