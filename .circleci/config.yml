version: 2.1
jobs:
  test-sitespeed:
    machine: true
    steps:
      # - run: sudo modprobe ifb numifbs=1
      - run:
          name: Run test
          command: |
            docker run --shm-size=1g --rm -v "$(pwd):/sitespeed.io" sitespeedio/sitespeed.io:latest -n 1 \
            https://stage.animedigitalnetwork.fr \
            --basicAuth ${BASIC_AUTH} \
            --slack.hookUrl ${SLACK_HOOK_URL} \
            --s3.key ${S3_KEY} \
            --s3.secret ${S3_SECRET} \
            --s3.bucketname ${S3_BUCKET}
      - run:
          name: Compress results
          command: tar -cf ~/project/results.tar ~/project/sitespeed-result
      - store_artifacts:
          path: ~/project/results.tar

workflows:
  build:
    jobs:
      - test-sitespeed:
          filters:
            branches:
              only: master
